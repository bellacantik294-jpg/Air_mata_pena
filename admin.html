<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Style utama website -->
  <link rel="stylesheet" href="style.css">

  <!-- Favicon (opsional) -->
  <link rel="icon" href="favicon.png">

  <title>Admin - Air Mata Pena</title>

  <!-- Quill Editor (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.snow.css" rel="stylesheet">

  <style>
    body {
      font-family: "Inter", sans-serif;
      padding:20px;
      background:#f7f4fb;
      color:#2f1b3a;
    }

    .admin-box {
      background:#ffffff;
      padding:25px;
      border-radius:16px;
      max-width:900px;
      margin:auto;
      box-shadow:0 5px 20px rgba(100,0,120,0.08);
    }

    input, textarea {
      width:100%;
      padding:12px;
      margin:10px 0;
      border-radius:10px;
      border:1px solid #c9b7e5;
      background:#faf7ff;
      color:#2f1b3a;
    }

    button {
      padding:10px 20px;
      margin-top:10px;
      background:#6E38A1;
      border:none;
      color:white;
      border-radius:10px;
      cursor:pointer;
      font-size:15px;
    }

    button:hover { background:#582b84; }

    .card {
      background:white;
      padding:15px;
      margin:15px 0;
      border-radius:12px;
      box-shadow:0 3px 10px rgba(80,0,90,0.09);
    }

    .del {
      background:#ff3366;
      margin-top:10px;
    }

    #preview-box {
      background:white;
      padding:20px;
      border-radius:12px;
      box-shadow:0 4px 20px rgba(0,0,0,0.1);
      display:none;
      white-space:pre-wrap;
    }

    .dashboard {
      padding:20px;
      border-radius:12px;
      background:#fff;
      margin-bottom:25px;
      box-shadow:0 4px 15px rgba(80,0,90,0.07);
    }

    .cover-preview {
      width:160px;
      height:220px;
      border-radius:12px;
      object-fit:cover;
      margin-top:10px;
      display:none;
    }
  </style>
</head>

<body>

  <main class="admin-box">

    <h2>Admin Panel â€“ Air Mata Pena</h2>

    <!-- Login -->
    <section class="admin-login">
      <input id="admin-email" placeholder="Email admin" />
      <input id="admin-pass" type="password" placeholder="Password" />
      <button id="btn-login">Login</button>
      <button id="btn-logout" style="display:none">Logout</button>
    </section>

    <!-- AREA ADMIN -->
    <section id="admin-area" style="display:none">

      <!-- DASHBOARD -->
      <div class="dashboard">
        <h3>ðŸ“Š Statistik</h3>
        <p>Total Cerpen: <b id="total-cerpen">0</b></p>
        <p>Terbaru: <b id="latest-title">-</b></p>
      </div>

      <!-- CREATE -->
      <h3>Buat Cerpen Baru</h3>

      <input id="title" placeholder="Judul" />

      <label>Cover Cerpen:</label>
      <input type="file" id="cover-input">
      <img id="cover-preview" class="cover-preview">

      <label>Isi Cerpen:</label>
      <div id="editor" style="height:250px;background:white;border-radius:12px;"></div>

      <button id="preview-btn">Preview</button>
      <button id="create">Publikasikan</button>

      <br><br>

      <!-- PREVIEW -->
      <div id="preview-box"></div>

      <h3>Daftar Cerpen</h3>
      <div id="list-cerpen"></div>
    </section>

  </main>

  <!-- FIREBASE CONFIG -->
  <script type="module" src="firebase-config.js"></script>

  <!-- QUILL JS -->
  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.js"></script>

  <!-- ADMIN SCRIPT -->
  <script type="module">
    import {
      adminSignIn,
      adminSignOut,
      createCerpen,
      listCerpen,
      deleteCerpen,
      uploadCover
    } from "./firebase-user.js";

    let quill = new Quill('#editor', {
      theme: 'snow',
      placeholder: 'Tulis cerpen di sini...',
      modules: {
        toolbar: [
          ['bold','italic','underline'],
          [{ 'header': [1,2,false]}],
          ['link','blockquote'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }]
        ]
      }
    });

    // ========== LOGIN ==========
    document.getElementById('btn-login').addEventListener('click', async ()=>{
      const email = admin-email.value;
      const pass = admin-pass.value;

      try {
        await adminSignIn(email, pass);
        alert("Login sukses!");

        admin-area.style.display = '';
        btn-logout.style.display = '';
        btn-login.style.display = 'none';

        loadList();
      } catch(e){
        alert("Login gagal: " + e.message);
      }
    });

    btn-logout.addEventListener('click', async ()=>{
      await adminSignOut();
      location.reload();
    });

    // ========== COVER PREVIEW ==========
    const coverInput = document.getElementById("cover-input");
    coverInput.onchange = () => {
      const file = coverInput.files[0];
      if(file){
        cover-preview.src = URL.createObjectURL(file);
        cover-preview.style.display = 'block';
      }
    };

    // ========== PREVIEW CERITA ==========
    preview-btn.onclick = () => {
      preview-box.innerHTML = `
        <h2>${title.value}</h2>
        <img src="${cover-preview.src}" style="max-width:200px;border-radius:12px">
        <br><br>
        ${quill.root.innerHTML}
      `;
      preview-box.style.display = "block";
    };

    // ========== AUTO SAVE ==========
    setInterval(()=>{
      localStorage.setItem("draft-title", title.value);
      localStorage.setItem("draft-body", quill.root.innerHTML);
    }, 800);

    window.onload = () => {
      title.value = localStorage.getItem("draft-title") || "";
      quill.root.innerHTML = localStorage.getItem("draft-body") || "";
    };

    // ========== CREATE CERPEN ==========
    create.onclick = async ()=>{
      const titleVal = title.value;
      const bodyVal = quill.root.innerHTML;

      if(!titleVal || !bodyVal) return alert("Judul & isi tidak boleh kosong");

      let coverURL = "";
      if(coverInput.files.length > 0){
        coverURL = await uploadCover(coverInput.files[0]);
      }

      await createCerpen({
        title: titleVal,
        body: bodyVal,
        cover: coverURL
      });

      alert("Cerpen dipublikasikan!");

      title.value = '';
      quill.root.innerHTML = '';
      localStorage.clear();

      loadList();
    };

    // ========== LIST CERPEN + DASHBOARD ==========
    async function loadList(){
      const node = document.getElementById('list-cerpen');
      node.innerHTML = "Memuat...";

      const items = await listCerpen(200);
      node.innerHTML = "";

      document.getElementById("total-cerpen").innerText = items.length;
      if(items.length > 0){
        document.getElementById("latest-title").innerText = items[0].title;
      }

      items.forEach(it=>{
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <h4>${it.title}</h4>
          <button class="del" data-id="${it.id}">Hapus</button>
        `;
        node.appendChild(div);
      });

      document.querySelectorAll('.del').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          if (!confirm("Hapus cerpen ini?")) return;
          await deleteCerpen(btn.dataset.id);
          loadList();
        });
      });
    }
  </script>

</body>
</html>
